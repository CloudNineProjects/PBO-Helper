<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PBO Helper</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #ffffff;
      color: #000000;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: flex-end;
      padding: 10px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      opacity: 0.9;
    }
    .section {
      margin: 20px;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .highlight {
      background-color: #FFE8C6;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
    }
    th, td {
      border: 1px solid #999;
      padding: 6px;
      text-align: left;
    }
    /* Loading screen */
    #loading-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
    }
    #app {
      display: none;
    }

    /* Dark mode */
    .dark-mode {
      background: #121212;
      color: #f1f1f1;
    }
    .dark-mode .section {
      border: 1px solid #555;
    }
    .dark-mode table {
      border: 1px solid #555;
      background: #1e1e1e;
    }
    .dark-mode th, 
    .dark-mode td {
      border: 1px solid #555;
      color: #f1f1f1;
    }
    .dark-mode .highlight {
      background: #5a4636;
    }
    .dark-mode button {
      background: #333;
      color: #f1f1f1;
    }
  </style>
</head>
<body>
  <!-- Dark Mode Toggle -->
  <header>
    <button id="darkModeToggle">ðŸŒ™ Dark Mode</button>
  </header>

  <!-- Loading Screen -->
  <div id="loading-screen">
    <img src="https://i.imgur.com/XZcfQzw.png" alt="Loading Logo" style="max-width:200px; margin-bottom:20px;">
    <button id="loadDataBtn">Load Data</button>
    <p id="loadingText"></p>
  </div>

  <!-- Main App -->
  <div id="app">
    <div class="section highlight">
      <h2>Pokemon Finder</h2>
      <input type="text" id="pokemonInput" placeholder="Enter PokÃ©mon name" />
      <label><input type="checkbox" id="optimizedHunt" /> Optimized Hunt</label>
      <button id="pokemonSearchBtn">Search</button>
      <button id="pokemonResetBtn">Reset</button>
      <div id="pokemonResults"></div>
    </div>

    <div class="section">
      <h2>Spawn Check</h2>
      <select id="regionSelect"><option value="">Select Region</option></select>
      <select id="locationSelect" disabled><option value="">Select Location</option></select>
      <button id="spawnSearchBtn">Search</button>
      <button id="spawnResetBtn">Reset</button>
      <div id="spawnResults"></div>
    </div>

    <div class="section highlight">
      <h2>Chest Finder</h2>
      <select id="chestSelect"><option value="">Select Type</option></select>
      <button id="chestSearchBtn">Search</button>
      <button id="chestResetBtn">Reset</button>
      <div id="chestResults"></div>
    </div>

    <div class="section">
      <h2>Mega Stone Check</h2>
      <select id="megaSelect"><option value="">Select Mega Stone</option></select>
      <button id="megaSearchBtn">Search</button>
      <button id="megaResetBtn">Reset</button>
      <div id="megaResults"></div>
    </div>

    <div class="section highlight">
      <h2>PVP Check</h2>
      <input type="text" id="pvpInput" placeholder="Enter PokÃ©mon name" />
      <button id="pvpSearchBtn">Search</button>
      <button id="pvpResetBtn">Reset</button>
      <div id="pvpResults"></div>
    </div>
  </div>

  <script>
    // --------------------
    // DARK MODE
    // --------------------
    const darkToggle = document.getElementById("darkModeToggle");
    darkToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      darkToggle.textContent = document.body.classList.contains("dark-mode") 
        ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
    });

    // --------------------
    // LOADING SCREEN
    // --------------------
    const loadBtn = document.getElementById("loadDataBtn");
    const loadText = document.getElementById("loadingText");
    const loadingScreen = document.getElementById("loading-screen");
    const app = document.getElementById("app");

    loadBtn.addEventListener("click", async () => {
      loadBtn.disabled = true;
      loadText.textContent = "Loading...";
      await loadData();
      loadingScreen.style.display = "none";
      app.style.display = "block";
    });

    // --------------------
    // DATA SOURCES
    // --------------------
    const spawnSheets = {
      "Sinnoh": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3eHdgBkA2DHukT5irO5O38RuYUZ3BDYfM0TCz9LATz0URiiKCSkyKtNFbfQkKR2pEzLbCeMh7saZe/pub?output=csv",
      "Jvaloh": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3eHdgBkA2DHukT5irO5O38RuYUZ3BDYfM0TCz9LATz0URiiKCSkyKtNFbfQkKR2pEzLbCeMh7saZe/pub?gid=961851118&output=csv",
      "Hoenn": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3eHdgBkA2DHukT5irO5O38RuYUZ3BDYfM0TCz9LATz0URiiKCSkyKtNFbfQkKR2pEzLbCeMh7saZe/pub?gid=934360191&output=csv",
      "Kanto": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3eHdgBkA2DHukT5irO5O38RuYUZ3BDYfM0TCz9LATz0URiiKCSkyKtNFbfQkKR2pEzLbCeMh7saZe/pub?gid=953981212&output=csv",
      "Event": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3eHdgBkA2DHukT5irO5O38RuYUZ3BDYfM0TCz9LATz0URiiKCSkyKtNFbfQkKR2pEzLbCeMh7saZe/pub?gid=1147933137&output=csv",
      "Crew Wars Island": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3eHdgBkA2DHukT5irO5O38RuYUZ3BDYfM0TCz9LATz0URiiKCSkyKtNFbfQkKR2pEzLbCeMh7saZe/pub?gid=2040577443&output=csv"
    };

    const chestSheet = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT9NXQeF7_DUFs-GSpxYU5QsufA6Vtwi_n5O6ytErPYQAssIC4zen99a23uPvYQXzjARPvF0XbXIiOn/pub?output=csv";

    const megaSheet = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_JYMoBaB85e1OwF6k2M6VjYflIF1A2bVRrXGvlCewxtM9AnpB4oYmMcja3r86emLUR1kzGw5Q9m4y/pub?output=csv";

    const pvpSheet = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRFVtU6sT8CPqOfyxCydKnN6AE98OhtA2XBCsmRbw70yZvLd4t6xGcU8-G9f5k6j6nlMOM8piwGXG78/pub?output=csv";

    let spawnData = {};
    let chestData = [];
    let megaData = [];
    let pvpData = [];

    // --------------------
    // CSV HELPER
    // --------------------
    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return text.split("\n").map(r => r.split(",").map(c => c.trim()));
    }

    // --------------------
    // LOADDATA
    // --------------------
    async function loadData() {
      // Spawn sheets
      for (let [region, url] of Object.entries(spawnSheets)) {
        spawnData[region] = await fetchCSV(url);
      }

      // Chest
      chestData = await fetchCSV(chestSheet);

      // Mega
      megaData = await fetchCSV(megaSheet);

      // PvP
      pvpData = await fetchCSV(pvpSheet);

      // Fill dropdowns
      const regionSelect = document.getElementById("regionSelect");
      Object.keys(spawnSheets).forEach(region => {
        const opt = document.createElement("option");
        opt.value = region;
        opt.textContent = region;
        regionSelect.appendChild(opt);
      });

      const chestSelect = document.getElementById("chestSelect");
      [...new Set(chestData.slice(1).map(r => r[0]))].forEach(type => {
        const opt = document.createElement("option");
        opt.value = type;
        opt.textContent = type;
        chestSelect.appendChild(opt);
      });

      const megaSelect = document.getElementById("megaSelect");
      [...new Set(megaData.slice(1).map(r => r[0]))].forEach(stone => {
        const opt = document.createElement("option");
        opt.value = stone;
        opt.textContent = stone;
        megaSelect.appendChild(opt);
      });
    }

    // --------------------
    // HELPER: RENDER TABLE
    // --------------------
    function renderTable(headers, rows) {
      if (!rows.length) return "<p>No results found.</p>";
      let html = "<table><thead><tr>";
      headers.forEach(h => html += `<th>${h}</th>`);
      html += "</tr></thead><tbody>";
      rows.forEach(r => {
        html += "<tr>" + r.map(c => `<td>${c}</td>`).join("") + "</tr>";
      });
      html += "</tbody></table>";
      return html;
    }

    // --------------------
    // POKEMON FINDER
    // --------------------
    document.getElementById("pokemonSearchBtn").addEventListener("click", () => {
      const query = document.getElementById("pokemonInput").value.trim().toLowerCase();
      const optimized = document.getElementById("optimizedHunt").checked;
      let results = [];

      // Search spawn sheets
      for (let [region, data] of Object.entries(spawnData)) {
        const headers = data[0];
        const rows = data.slice(1).filter(r => r[2] && r[2].toLowerCase() === query);
        if (rows.length) {
          if (optimized) {
            const optimizedRows = rows.filter(row => {
              const location = row[1];
              const method = row[5];
              return data.slice(1).some(other => 
                other[1] === location &&
                other[5] === method &&
                other[3] === "Ultra Rare"
              );
            });
            if (optimizedRows.length) {
              results.push({ region, headers, rows: optimizedRows });
            }
          } else {
            results.push({ region, headers, rows });
          }
        }
      }

      // Search chests
      const chestRows = chestData.slice(1).filter(r => r[2] && r[2].toLowerCase() === query);
      if (chestRows.length) {
        results.push({ region: "Chests", headers: chestData[0], rows: chestRows });
      }

      const container = document.getElementById("pokemonResults");
      container.innerHTML = results.length 
        ? results.map(r => `<h3>${r.region}</h3>` + renderTable(r.headers, r.rows)).join("")
        : "<p>Currently not listed...</p>";
    });

    document.getElementById("pokemonResetBtn").addEventListener("click", () => {
      document.getElementById("pokemonInput").value = "";
      document.getElementById("pokemonResults").innerHTML = "";
    });

    // --------------------
    // SPAWN CHECK
    // --------------------
    document.getElementById("regionSelect").addEventListener("change", e => {
      const region = e.target.value;
      const locationSelect = document.getElementById("locationSelect");
      locationSelect.innerHTML = "<option value=''>Select Location</option>";
      if (region) {
        const data = spawnData[region];
        [...new Set(data.slice(1).map(r => r[1]))].forEach(loc => {
          const opt = document.createElement("option");
          opt.value = loc;
          opt.textContent = loc;
          locationSelect.appendChild(opt);
        });
        locationSelect.disabled = false;
      } else {
        locationSelect.disabled = true;
      }
    });

    document.getElementById("spawnSearchBtn").addEventListener("click", () => {
      const region = document.getElementById("regionSelect").value;
      const location = document.getElementById("locationSelect").value;
      const container = document.getElementById("spawnResults");
      if (region && location) {
        const data = spawnData[region];
        const headers = data[0];
        const rows = data.slice(1).filter(r => r[1] === location);
        container.innerHTML = renderTable(headers, rows);
      } else {
        container.innerHTML = "<p>Please select both region and location.</p>";
      }
    });

    document.getElementById("spawnResetBtn").addEventListener("click", () => {
      document.getElementById("regionSelect").value = "";
      document.getElementById("locationSelect").innerHTML = "<option value=''>Select Location</option>";
      document.getElementById("locationSelect").disabled = true;
      document.getElementById("spawnResults").innerHTML = "";
    });

    // --------------------
    // CHEST FINDER
    // --------------------
    document.getElementById("chestSearchBtn").addEventListener("click", () => {
      const type = document.getElementById("chestSelect").value;
      const container = document.getElementById("chestResults");
      if (type) {
        const headers = chestData[0];
        const rows = chestData.slice(1).filter(r => r[0] === type);
        container.innerHTML = renderTable(headers, rows);
      } else {
        container.innerHTML = "<p>Please select a type.</p>";
      }
    });

    document.getElementById("chestResetBtn").addEventListener("click", () => {
      document.getElementById("chestSelect").value = "";
      document.getElementById("chestResults").innerHTML = "";
    });

    // --------------------
    // MEGA STONE CHECK
    // --------------------
    document.getElementById("megaSearchBtn").addEventListener("click", () => {
      const stone = document.getElementById("megaSelect").value;
      const container = document.getElementById("megaResults");
      if (stone) {
        const headers = megaData[0];
        const rows = megaData.slice(1).filter(r => r[0] === stone);
        container.innerHTML = renderTable(headers, rows);
      } else {
        container.innerHTML = "<p>Please select a mega stone.</p>";
      }
    });

    document.getElementById("megaResetBtn").addEventListener("click", () => {
      document.getElementById("megaSelect").value = "";
      document.getElementById("megaResults").innerHTML = "";
    });

    // --------------------
    // PVP CHECK
    // --------------------
    document.getElementById("pvpSearchBtn").addEventListener("click", () => {
      const query = document.getElementById("pvpInput").value.trim().toLowerCase();
      const headers = pvpData[0];
      const rows = pvpData.slice(1).filter(r => r[0] && r[0].toLowerCase() === query);
      const container = document.getElementById("pvpResults");
      container.innerHTML = rows.length ? renderTable(headers, rows) : "<p>Currently not listed...</p>";
    });

    document.getElementById("pvpResetBtn").addEventListener("click", () => {
      document.getElementById("pvpInput").value = "";
      document.getElementById("pvpResults").innerHTML = "";
    });

  </script>
</body>
</html>
